[mongo-baseops](../README.md) / [Exports](../modules.md) / [\<internal\>](../modules/internal_.md) / ["Z:/mongo-baseOps/node\_modules/mongodb/mongodb"](../modules/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.md) / ClientEncryption

# Class: ClientEncryption

[\<internal\>](../modules/internal_.md).["Z:/mongo-baseOps/node\_modules/mongodb/mongodb"](../modules/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.md).ClientEncryption

The public interface for explicit in-use encryption

## Table of contents

### Constructors

- [constructor](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md#constructor)

### Accessors

- [libmongocryptVersion](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md#libmongocryptversion)

### Methods

- [addKeyAltName](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md#addkeyaltname)
- [createDataKey](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md#createdatakey)
- [createEncryptedCollection](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md#createencryptedcollection)
- [decrypt](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md#decrypt)
- [deleteKey](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md#deletekey)
- [encrypt](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md#encrypt)
- [encryptExpression](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md#encryptexpression)
- [getKey](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md#getkey)
- [getKeyByAltName](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md#getkeybyaltname)
- [getKeys](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md#getkeys)
- [removeKeyAltName](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md#removekeyaltname)
- [rewrapManyDataKey](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md#rewrapmanydatakey)

## Constructors

### constructor

• **new ClientEncryption**(`client`, `options`): [`ClientEncryption`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md)

Create a new encryption instance

#### Parameters

| Name | Type |
| :------ | :------ |
| `client` | [`MongoClient`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.MongoClient.md) |
| `options` | [`ClientEncryptionOptions`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryptionOptions.md) |

#### Returns

[`ClientEncryption`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryption.md)

**`Example`**

```ts
new ClientEncryption(mongoClient, {
  keyVaultNamespace: 'client.encryption',
  kmsProviders: {
    local: {
      key: masterKey // The master key used for encryption/decryption. A 96-byte long Buffer
    }
  }
});
```

**`Example`**

```ts
new ClientEncryption(mongoClient, {
  keyVaultNamespace: 'client.encryption',
  kmsProviders: {
    aws: {
      accessKeyId: AWS_ACCESS_KEY,
      secretAccessKey: AWS_SECRET_KEY
    }
  }
});
```

#### Defined in

node_modules/mongodb/mongodb.d.ts:1476

## Accessors

### libmongocryptVersion

• `get` **libmongocryptVersion**(): `string`

#### Returns

`string`

#### Defined in

node_modules/mongodb/mongodb.d.ts:1731

## Methods

### addKeyAltName

▸ **addKeyAltName**(`_id`, `keyAltName`): `Promise`\<``null`` \| [`WithId`](../modules/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.md#withid)\<[`DataKey`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DataKey.md)\>\>

Adds a keyAltName to a key identified by the provided _id.

This method resolves to/returns the *old* key value (prior to adding the new altKeyName).

#### Parameters

| Name | Type | Description |
| :------ | :------ | :------ |
| `_id` | [`Binary`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.Binary.md) | The id of the document to update. |
| `keyAltName` | `string` | a keyAltName to search for a key |

#### Returns

`Promise`\<``null`` \| [`WithId`](../modules/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.md#withid)\<[`DataKey`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DataKey.md)\>\>

Returns a promise that either resolves to a [DataKey](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DataKey.md) if a document matches the key or null if no documents
match the id.  The promise rejects with an error if an error is thrown.

**`Example`**

```ts
// adding an keyAltName to a data key
const id = new Binary();  // id is a bson binary subtype 4 object
const keyAltName = 'keyAltName';
const oldKey = await clientEncryption.addKeyAltName(id, keyAltName);
if (!oldKey) {
 // null is returned if there is no matching document with an id matching the supplied id
}
```

#### Defined in

node_modules/mongodb/mongodb.d.ts:1622

___

### createDataKey

▸ **createDataKey**(`provider`, `options?`): `Promise`\<[`UUID`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.BSON.UUID.md)\>

Creates a data key used for explicit encryption and inserts it into the key vault namespace

#### Parameters

| Name | Type |
| :------ | :------ |
| `provider` | [`ClientEncryptionDataKeyProvider`](../modules/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.md#clientencryptiondatakeyprovider) |
| `options?` | [`ClientEncryptionCreateDataKeyProviderOptions`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryptionCreateDataKeyProviderOptions.md) |

#### Returns

`Promise`\<[`UUID`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.BSON.UUID.md)\>

**`Example`**

```ts
// Using async/await to create a local key
const dataKeyId = await clientEncryption.createDataKey('local');
```

**`Example`**

```ts
// Using async/await to create an aws key
const dataKeyId = await clientEncryption.createDataKey('aws', {
  masterKey: {
    region: 'us-east-1',
    key: 'xxxxxxxxxxxxxx' // CMK ARN here
  }
});
```

**`Example`**

```ts
// Using async/await to create an aws key with a keyAltName
const dataKeyId = await clientEncryption.createDataKey('aws', {
  masterKey: {
    region: 'us-east-1',
    key: 'xxxxxxxxxxxxxx' // CMK ARN here
  },
  keyAltNames: [ 'mySpecialKey' ]
});
```

#### Defined in

node_modules/mongodb/mongodb.d.ts:1509

___

### createEncryptedCollection

▸ **createEncryptedCollection**\<`TSchema`\>(`db`, `name`, `options`): `Promise`\<\{ `collection`: [`Collection`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.Collection.md)\<`TSchema`\> ; `encryptedFields`: [`Document`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.BSON.Document.md)  }\>

A convenience method for creating an encrypted collection.
This method will create data keys for any encryptedFields that do not have a `keyId` defined
and then create a new collection with the full set of encryptedFields.

#### Type parameters

| Name | Type |
| :------ | :------ |
| `TSchema` | extends [`Document`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.BSON.Document.md) = [`Document`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.BSON.Document.md) |

#### Parameters

| Name | Type | Description |
| :------ | :------ | :------ |
| `db` | [`Db`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.Db.md) | A Node.js driver Db object with which to create the collection |
| `name` | `string` | The name of the collection to be created |
| `options` | `Object` | Options for createDataKey and for createCollection |
| `options.createCollectionOptions` | [`Omit`](../modules/internal_.md#omit)\<[`CreateCollectionOptions`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.CreateCollectionOptions.md), ``"encryptedFields"``\> & \{ `encryptedFields`: [`Document`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.BSON.Document.md)  } | - |
| `options.masterKey?` | [`AWSEncryptionKeyOptions`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.AWSEncryptionKeyOptions.md) \| [`AzureEncryptionKeyOptions`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.AzureEncryptionKeyOptions.md) \| [`GCPEncryptionKeyOptions`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.GCPEncryptionKeyOptions.md) | - |
| `options.provider` | [`ClientEncryptionDataKeyProvider`](../modules/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.md#clientencryptiondatakeyprovider) | - |

#### Returns

`Promise`\<\{ `collection`: [`Collection`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.Collection.md)\<`TSchema`\> ; `encryptedFields`: [`Document`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.BSON.Document.md)  }\>

created collection and generated encryptedFields

**`Throws`**

MongoCryptCreateDataKeyError - If part way through the process a createDataKey invocation fails, an error will be rejected that has the partial `encryptedFields` that were created.

**`Throws`**

MongoCryptCreateEncryptedCollectionError - If creating the collection fails, an error will be rejected that has the entire `encryptedFields` that were created.

#### Defined in

node_modules/mongodb/mongodb.d.ts:1659

___

### decrypt

▸ **decrypt**\<`T`\>(`value`): `Promise`\<`T`\>

Explicitly decrypt a provided encrypted value

#### Type parameters

| Name | Type |
| :------ | :------ |
| `T` | `any` |

#### Parameters

| Name | Type | Description |
| :------ | :------ | :------ |
| `value` | [`Binary`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.Binary.md) | An encrypted value |

#### Returns

`Promise`\<`T`\>

a Promise that either resolves with the decrypted value, or rejects with an error

**`Example`**

```ts
// Decrypting value with async/await API
async function decryptMyValue(value) {
  return clientEncryption.decrypt(value);
}
```

#### Defined in

node_modules/mongodb/mongodb.d.ts:1729

___

### deleteKey

▸ **deleteKey**(`_id`): `Promise`\<[`DeleteResult`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DeleteResult.md)\>

Deletes the key with the provided id from the keyvault, if it exists.

#### Parameters

| Name | Type |
| :------ | :------ |
| `_id` | [`Binary`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.Binary.md) |

#### Returns

`Promise`\<[`DeleteResult`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DeleteResult.md)\>

**`Example`**

```ts
// delete a key by _id
const id = new Binary(); // id is a bson binary subtype 4 object
const { deletedCount } = await clientEncryption.deleteKey(id);

if (deletedCount != null && deletedCount > 0) {
  // successful deletion
}
```

#### Defined in

node_modules/mongodb/mongodb.d.ts:1555

___

### encrypt

▸ **encrypt**(`value`, `options`): `Promise`\<[`Binary`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.Binary.md)\>

Explicitly encrypt a provided value. Note that either `options.keyId` or `options.keyAltName` must
be specified. Specifying both `options.keyId` and `options.keyAltName` is considered an error.

#### Parameters

| Name | Type | Description |
| :------ | :------ | :------ |
| `value` | `unknown` | The value that you wish to serialize. Must be of a type that can be serialized into BSON |
| `options` | [`ClientEncryptionEncryptOptions`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryptionEncryptOptions.md) |  |

#### Returns

`Promise`\<[`Binary`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.Binary.md)\>

a Promise that either resolves with the encrypted value, or rejects with an error.

**`Example`**

```ts
// Encryption with async/await api
async function encryptMyData(value) {
  const keyId = await clientEncryption.createDataKey('local');
  return clientEncryption.encrypt(value, { keyId, algorithm: 'AEAD_AES_256_CBC_HMAC_SHA_512-Deterministic' });
}
```

**`Example`**

```ts
// Encryption using a keyAltName
async function encryptMyData(value) {
  await clientEncryption.createDataKey('local', { keyAltNames: 'mySpecialKey' });
  return clientEncryption.encrypt(value, { keyAltName: 'mySpecialKey', algorithm: 'AEAD_AES_256_CBC_HMAC_SHA_512-Deterministic' });
}
```

#### Defined in

node_modules/mongodb/mongodb.d.ts:1695

___

### encryptExpression

▸ **encryptExpression**(`expression`, `options`): `Promise`\<[`Binary`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.Binary.md)\>

Encrypts a Match Expression or Aggregate Expression to query a range index.

Only supported when queryType is "rangePreview" and algorithm is "RangePreview".

 The Range algorithm is experimental only. It is not intended for production use. It is subject to breaking changes.

#### Parameters

| Name | Type | Description |
| :------ | :------ | :------ |
| `expression` | [`Document`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.BSON.Document.md) | a BSON document of one of the following forms: 1. A Match Expression of this form: `{$and: [{<field>: {$gt: <value1>}}, {<field>: {$lt: <value2> }}]}` 2. An Aggregate Expression of this form: `{$and: [{$gt: [<fieldpath>, <value1>]}, {$lt: [<fieldpath>, <value2>]}]}` `$gt` may also be `$gte`. `$lt` may also be `$lte`. |
| `options` | [`ClientEncryptionEncryptOptions`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryptionEncryptOptions.md) |  |

#### Returns

`Promise`\<[`Binary`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.Binary.md)\>

Returns a Promise that either resolves with the encrypted value or rejects with an error.

#### Defined in

node_modules/mongodb/mongodb.d.ts:1714

___

### getKey

▸ **getKey**(`_id`): `Promise`\<``null`` \| [`DataKey`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DataKey.md)\>

Finds a key in the keyvault with the specified _id.

Returns a promise that either resolves to a [DataKey](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DataKey.md) if a document matches the key or null if no documents
match the id.  The promise rejects with an error if an error is thrown.

#### Parameters

| Name | Type |
| :------ | :------ |
| `_id` | [`Binary`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.Binary.md) |

#### Returns

`Promise`\<``null`` \| [`DataKey`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DataKey.md)\>

**`Example`**

```ts
// getting a key by id
const id = new Binary(); // id is a bson binary subtype 4 object
const key = await clientEncryption.getKey(id);
if (!key) {
 // key is null if there was no matching key
}
```

#### Defined in

node_modules/mongodb/mongodb.d.ts:1584

___

### getKeyByAltName

▸ **getKeyByAltName**(`keyAltName`): `Promise`\<``null`` \| [`WithId`](../modules/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.md#withid)\<[`DataKey`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DataKey.md)\>\>

Finds a key in the keyvault which has the specified keyAltName.

#### Parameters

| Name | Type | Description |
| :------ | :------ | :------ |
| `keyAltName` | `string` | a keyAltName to search for a key |

#### Returns

`Promise`\<``null`` \| [`WithId`](../modules/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.md#withid)\<[`DataKey`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DataKey.md)\>\>

Returns a promise that either resolves to a [DataKey](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DataKey.md) if a document matches the key or null if no documents
match the keyAltName.  The promise rejects with an error if an error is thrown.

**`Example`**

```ts
// get a key by alt name
const keyAltName = 'keyAltName';
const key = await clientEncryption.getKeyByAltName(keyAltName);
if (!key) {
 // key is null if there is no matching key
}
```

#### Defined in

node_modules/mongodb/mongodb.d.ts:1601

___

### getKeys

▸ **getKeys**(): [`FindCursor`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.FindCursor.md)\<[`DataKey`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DataKey.md)\>

Finds all the keys currently stored in the keyvault.

This method will not throw.

#### Returns

[`FindCursor`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.FindCursor.md)\<[`DataKey`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DataKey.md)\>

a FindCursor over all keys in the keyvault.

**`Example`**

```ts
// fetching all keys
const keys = await clientEncryption.getKeys().toArray();
```

#### Defined in

node_modules/mongodb/mongodb.d.ts:1568

___

### removeKeyAltName

▸ **removeKeyAltName**(`_id`, `keyAltName`): `Promise`\<``null`` \| [`WithId`](../modules/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.md#withid)\<[`DataKey`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DataKey.md)\>\>

Adds a keyAltName to a key identified by the provided _id.

This method resolves to/returns the *old* key value (prior to removing the new altKeyName).

If the removed keyAltName is the last keyAltName for that key, the `altKeyNames` property is unset from the document.

#### Parameters

| Name | Type | Description |
| :------ | :------ | :------ |
| `_id` | [`Binary`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.Binary.md) | The id of the document to update. |
| `keyAltName` | `string` | a keyAltName to search for a key |

#### Returns

`Promise`\<``null`` \| [`WithId`](../modules/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.md#withid)\<[`DataKey`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DataKey.md)\>\>

Returns a promise that either resolves to a [DataKey](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DataKey.md) if a document matches the key or null if no documents
match the id.  The promise rejects with an error if an error is thrown.

**`Example`**

```ts
// removing a key alt name from a data key
const id = new Binary();  // id is a bson binary subtype 4 object
const keyAltName = 'keyAltName';
const oldKey = await clientEncryption.removeKeyAltName(id, keyAltName);

if (!oldKey) {
 // null is returned if there is no matching document with an id matching the supplied id
}
```

#### Defined in

node_modules/mongodb/mongodb.d.ts:1646

___

### rewrapManyDataKey

▸ **rewrapManyDataKey**(`filter`, `options`): `Promise`\<\{ `bulkWriteResult?`: [`BulkWriteResult`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.BulkWriteResult.md)  }\>

Searches the keyvault for any data keys matching the provided filter.  If there are matches, rewrapManyDataKey then attempts to re-wrap the data keys using the provided options.

If no matches are found, then no bulk write is performed.

#### Parameters

| Name | Type |
| :------ | :------ |
| `filter` | [`Filter`](../modules/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.md#filter)\<[`DataKey`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.DataKey.md)\> |
| `options` | [`ClientEncryptionRewrapManyDataKeyProviderOptions`](../interfaces/internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.ClientEncryptionRewrapManyDataKeyProviderOptions.md) |

#### Returns

`Promise`\<\{ `bulkWriteResult?`: [`BulkWriteResult`](internal_._Z__mongo_baseOps_node_modules_mongodb_mongodb_.BulkWriteResult.md)  }\>

**`Example`**

```ts
// rewrapping all data data keys (using a filter that matches all documents)
const filter = {};

const result = await clientEncryption.rewrapManyDataKey(filter);
if (result.bulkWriteResult != null) {
 // keys were re-wrapped, results will be available in the bulkWrite object.
}
```

**`Example`**

```ts
// attempting to rewrap all data keys with no matches
const filter = { _id: new Binary() } // assume _id matches no documents in the database
const result = await clientEncryption.rewrapManyDataKey(filter);

if (result.bulkWriteResult == null) {
 // no keys matched, `bulkWriteResult` does not exist on the result object
}
```

#### Defined in

node_modules/mongodb/mongodb.d.ts:1537
